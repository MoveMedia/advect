var D=Object.create;var{getPrototypeOf:R,defineProperty:q,getOwnPropertyNames:Q}=Object;var V=Object.prototype.hasOwnProperty;var M=(z,F,I)=>{I=z!=null?D(R(z)):{};const B=F||!z||!z.__esModule?q(I,"default",{value:z,enumerable:!0}):I;for(let E of Q(z))if(!V.call(B,E))q(B,E,{get:()=>z[E],enumerable:!0});return B};var f=(z,F)=>()=>(F||z((F={exports:{}}).exports,F),F.exports);var W={TEXT:0,TAG_OPEN:1,TAG_CLOSE:2,ATTRIBUTE_NAME:3,ATTRIBUTE_VALUE:4,SELF_CLOSING_TAG:5},w=new Set(["area","base","br","col","embed","hr","img","input","link","meta","source","track","wbr","att","attr","mutation","intersection"]);class Y{constructor(z,F,I,B){this.tagName=z,this.attributes=F,this.children=I,this.content=B,this.isRemoved=!1,this.isSelfClosing=!1}html(){if(this.isRemoved)return"";let z=this.content||"";for(let F of this.children)z+=F.html();if(this.isSelfClosing)return`<${this.tagName}${this.getAttributesString()} />`;return`<${this.tagName}${this.getAttributesString()}>${z}</${this.tagName}>`}text(){return this.isRemoved?"":this.content||""}getElementById(z){if(this.isRemoved)return null;if(this.attributes.id===z)return this;for(let F of this.children){const I=F.getElementById(z);if(I)return I}return null}getElementsByClass(z){if(this.isRemoved)return[];const F=[];if(this.attributes.class&&this.attributes.class.split(" ").includes(z))F.push(this);for(let I of this.children)F.push(...I.getElementsByClass(z));return F}remove(){this.isRemoved=!0}unRemove(){this.isRemoved=!1}hidden(){this.attributes.style="display: none;"}show(){if(this.attributes.style)delete this.attributes.style}filterAttributes(z){if(z.includes("*"))return;const F={};for(let[I,B]of Object.entries(this.attributes))if(z.includes(I))F[I]=B;this.attributes=F;for(let I of this.children)I.filterAttributes(z)}getAttributesString(){return Object.entries(this.attributes).map(([z,F])=>` ${z}="${F}"`).join("")}static create(z){const F=Y.tokenize(z),I=[],B=[];let E=null,O={},S="";for(let U of F)switch(U.type){case W.TAG_OPEN:if(E){if(Object.keys(E.attributes).length===0)E.attributes=O;E.content=S.trim(),O={},S="",B.push(E)}E=new Y(U.value,{},[]);break;case W.ATTRIBUTE_NAME:O[U.value]="";break;case W.ATTRIBUTE_VALUE:const P=Object.keys(O).pop();O[P]=U.value;break;case W.TAG_CLOSE:case W.SELF_CLOSING_TAG:if(!E)break;if(E.isSelfClosing=U.type===W.SELF_CLOSING_TAG,Object.keys(E.attributes).length===0)E.attributes=O;if(!E.content)E.content=S;else E.content+=" "+S;if(S="",O={},B.length>0)B[B.length-1].children.push(E);else I.push(E);E=B.pop()||null;break;case W.TEXT:if(E)S+=U.value;break}return I}static tokenize(z){const F=[];let I=0;while(I<z.length)if(z[I]==="<")if(z[I+1]==="/"){let B=I+2;while(B<z.length&&z[B]!==">")B++;F.push({type:W.TAG_CLOSE,value:z.slice(I+2,B).trim()}),I=B+1}else{let B=I+1;while(B<z.length&&z[B]!==" "&&z[B]!==">"&&z[B]!=="/")B++;const E=z.slice(I+1,B).trim();F.push({type:W.TAG_OPEN,value:z.slice(I+1,B).trim()});while(B<z.length&&z[B]!==">")if(z[B]===" "){B++;let O="";while(B<z.length&&z[B]!=="="&&z[B]!==" "&&z[B]!==">"&&z[B]!=="/")O+=z[B],B++;if(O!=="")F.push({type:W.ATTRIBUTE_NAME,value:O.trim().toLowerCase()});if(z[B]==="="){B++;const S=z[B];B++;let U="";while(B<z.length&&z[B]!==S)U+=z[B],B++;F.push({type:W.ATTRIBUTE_VALUE,value:U}),B++}}else B++;if(w.has(E.toLowerCase())&&z[B]===">")F.push({type:W.SELF_CLOSING_TAG,value:E});if(z[B]===">")B++;I=B}else{let B=I;while(B<z.length&&z[B]!=="<")B++;F.push({type:W.TEXT,value:z.slice(I,B)}),I=B}return F}}function x(z){return Object.keys(C).find((F)=>F.toLowerCase()==z.toLocaleLowerCase())!=null}function y(z,F){return import("data:text/javascript;charset=utf-8,"+F.join("\n")+encodeURIComponent(`${z}`)).then((B)=>B).catch((B)=>{return console.error(B),null})}function L(z){switch(z.data?.___type){case"table":console.table(z.data);break;case"dir":console.dir(z.data);break;case"error":console.error(z.data);break;case"warn":console.warn(z.data);break;default:case"log":console.log(z.data);break}}function X(z){G.postMessage({...z,___type:"log"})}var C={number:{},string:{},bigint:{},color:{}};var b=Object.getPrototypeOf(async function(){}).constructor,G=new BroadcastChannel("advect:log");G.onmessage=(z)=>L(z);var Z={async prerender(z){return X({renderDesc:z}),""},async load({urls:z}){X({message:"starting my loading",urls:z});const F=[],I=[];if(Array.isArray(z))I.push(...z);if(typeof z=="string")I.push(z);for(let B of I){const E=await fetch(B).then((O)=>O.text()).then(async(O)=>await this.build({template:O}));X({msg:"wow loading some stuff",url:B,data:E}),F.push(...E)}return X({message:"done loading",urls:z}),F},async build({template:z}){const F=Y.create(String.raw`${z}`),I=[];X({message:"building",template:z,root_nodes:F});for(let B of F){X({message:"Adding",root_node:B.attributes.id});const E={tagName:"",module:"",template:"",templateNode:null,refs:[],root:"light",shadow:"closed",watched_attrs:{},mutation:{attributeFilter:[],attributes:!0,characterData:!1,childList:!0,subtree:!0},intersection:{margin:0.5,threshhold:1},logs:[]};if(B.tagName.toLowerCase()==="template"){if(!B.attributes.id){X("advect Template must have an id that will become the tag name");continue}const S=B.attributes.id;if(S.indexOf("-")===-1){X("advect Template tag name must contain a hyphen");continue}if(E.tagName=S,E.templateNode=B,B.attributes.root)E.root=B.attributes.root;else E.root="light";if(B.attributes.shadow)E.shadow=B.attributes.shadow;else E.shadow="closed";const U=[...B.children];while(U.length>0){const P=U.shift();if(!P)continue;if(P.tagName==="settings")P.children.forEach((J)=>{if(J.tagName=="mutation"){if(E?.mutation?.attributeFilter&&J.attributes.attributeFilter)E.mutation.attributeFilter=J.attributes.attributeFilter.split(",");if(E?.mutation?.attributes&&J.attributes.attributes)E.mutation.attributes=J.attributes.attributes.toLocaleLowerCase().indexOf("true")!=-1;if(E?.mutation?.characterData&&J.attributes.characterData)E.mutation.characterData=J.attributes.characterData.toLocaleLowerCase().indexOf("true")!=-1;if(E?.mutation?.childList&&J.attributes.childList)E.mutation.childList=J.attributes.childList.toLocaleLowerCase().indexOf("true")!=-1;if(E?.mutation?.subtree&&J.attributes.subtree)E.mutation.subtree=J.attributes.subtree.toLocaleLowerCase().indexOf("true")!=-1}if(J.tagName=="intersection"){if(E?.intersection&&J.attributes.margin)E.intersection.margin=parseFloat(J.attributes.margin);if(E?.intersection.threshhold&&J.attributes.threshhold)E.intersection.threshhold=parseFloat(J.attributes.threshhold);if(E?.intersection.root&&J.attributes.root)E.intersection.root=J.attributes.root}if(J.tagName=="attr"&&J.attributes.name){const K=J.attributes.name,$=J.attributes.type??"string";if(x($))E.watched_attrs[K]={type:$}}J.remove()}),P.remove();if(P.tagName==="script"){if(P.attributes.type.toLocaleLowerCase()==="text/adv"&&P.attributes.type){const J=new URL(P.attributes.src);this.load({urls:J.toString()})}if(P.attributes.type.toLocaleLowerCase()==="module"&&!P.attributes.src)E.module=P.text()}if(P.attributes.ref)E.refs.push(P);U.push(...P.children)}}const O=B.children.map((S)=>S.html()).join("");E.template=O,I.push(E)}return I}};onmessage=(z)=>{const{data:F}=z;if(F&&F.action&&Z[F.action])try{Z[F.action].call(null,F.data).then((I)=>{postMessage({action:F.action,result:I,$id:F.$id})})}catch(I){postMessage({action:F.action,result:I,$id:F.$id,isError:!0})}else console.warn("Unknown action",F)};
