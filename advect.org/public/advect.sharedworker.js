var V=Object.create;var{getPrototypeOf:S,defineProperty:O,getOwnPropertyNames:f}=Object;var M=Object.prototype.hasOwnProperty;var A=(x,B,I)=>{I=x!=null?V(S(x)):{};const z=B||!x||!x.__esModule?O(I,"default",{value:x,enumerable:!0}):I;for(let G of f(x))if(!M.call(z,G))O(z,G,{get:()=>x[G],enumerable:!0});return z};var b=(x,B)=>()=>(B||x((B={exports:{}}).exports,B),B.exports);var W={TEXT:0,TAG_OPEN:1,TAG_CLOSE:2,ATTRIBUTE_NAME:3,ATTRIBUTE_VALUE:4,SELF_CLOSING_TAG:5},C=new Set(["area","base","br","col","embed","hr","img","input","link","meta","source","track","wbr","att","attr","mutation","intersection"]);class Z{constructor(x,B,I,z){this.tagName=x,this.attributes=B,this.children=I,this.content=z,this.isRemoved=!1,this.isSelfClosing=!1}html(){if(this.isRemoved)return"";let x=this.content||"";for(let B of this.children)x+=B.html();if(this.isSelfClosing)return`<${this.tagName}${this.getAttributesString()} />`;return`<${this.tagName}${this.getAttributesString()}>${x}</${this.tagName}>`}text(){return this.isRemoved?"":this.content||""}getElementById(x){if(this.isRemoved)return null;if(this.attributes.id===x)return this;for(let B of this.children){const I=B.getElementById(x);if(I)return I}return null}getElementsByClass(x){if(this.isRemoved)return[];const B=[];if(this.attributes.class&&this.attributes.class.split(" ").includes(x))B.push(this);for(let I of this.children)B.push(...I.getElementsByClass(x));return B}remove(){this.isRemoved=!0}unRemove(){this.isRemoved=!1}hidden(){this.attributes.style="display: none;"}show(){if(this.attributes.style)delete this.attributes.style}filterAttributes(x){if(x.includes("*"))return;const B={};for(let[I,z]of Object.entries(this.attributes))if(x.includes(I))B[I]=z;this.attributes=B;for(let I of this.children)I.filterAttributes(x)}getAttributesString(){return Object.entries(this.attributes).map(([x,B])=>` ${x}="${B}"`).join("")}static create(x){const B=Z.tokenize(x),I=[],z=[];let G=null,D={},X="";for(let P of B)switch(P.type){case W.TAG_OPEN:if(G){if(Object.keys(G.attributes).length===0)G.attributes=D;G.content=X.trim(),D={},X="",z.push(G)}G=new Z(P.value,{},[]);break;case W.ATTRIBUTE_NAME:D[P.value]="";break;case W.ATTRIBUTE_VALUE:const Y=Object.keys(D).pop();D[Y]=P.value;break;case W.TAG_CLOSE:case W.SELF_CLOSING_TAG:if(!G)break;if(G.isSelfClosing=P.type===W.SELF_CLOSING_TAG,Object.keys(G.attributes).length===0)G.attributes=D;if(!G.content)G.content=X;else G.content+=" "+X;if(X="",D={},z.length>0)z[z.length-1].children.push(G);else I.push(G);G=z.pop()||null;break;case W.TEXT:if(G)X+=P.value;break}return I}static tokenize(x){const B=[];let I=0;while(I<x.length)if(x[I]==="<")if(x[I+1]==="/"){let z=I+2;while(z<x.length&&x[z]!==">")z++;B.push({type:W.TAG_CLOSE,value:x.slice(I+2,z).trim()}),I=z+1}else{let z=I+1;while(z<x.length&&x[z]!==" "&&x[z]!==">"&&x[z]!=="/")z++;const G=x.slice(I+1,z).trim();B.push({type:W.TAG_OPEN,value:x.slice(I+1,z).trim()});while(z<x.length&&x[z]!==">")if(x[z]===" "){z++;let D="";while(z<x.length&&x[z]!=="="&&x[z]!==" "&&x[z]!==">"&&x[z]!=="/")D+=x[z],z++;if(D!=="")B.push({type:W.ATTRIBUTE_NAME,value:D.trim().toLowerCase()});if(x[z]==="="){z++;const X=x[z];z++;let P="";while(z<x.length&&x[z]!==X)P+=x[z],z++;B.push({type:W.ATTRIBUTE_VALUE,value:P}),z++}}else z++;if(C.has(G.toLowerCase())&&x[z]===">")B.push({type:W.SELF_CLOSING_TAG,value:G});if(x[z]===">")z++;I=z}else{let z=I;while(z<x.length&&x[z]!=="<")z++;B.push({type:W.TEXT,value:x.slice(I,z)}),I=z}return B}}function q(x){return Object.keys(H).find((B)=>B.toLowerCase()==x.toLocaleLowerCase())!=null}function k(x,B){return import("data:text/javascript;charset=utf-8,"+B.join("\n")+encodeURIComponent(`${x}`)).then((z)=>z).catch((z)=>{return console.error(z),null})}function w(x){switch(x.data?.___type){case"table":console.table(x.data);break;case"dir":console.dir(x.data);break;case"error":console.error(x.data);break;case"warn":console.warn(x.data);break;default:case"log":console.log(x.data);break}}function Q(x){return x.replace(/<!--[\s\S]*?-->/g,"")}function v(x){return x.toLowerCase().split("-").map((B)=>B.charAt(0).toUpperCase()+B.slice(1)).join("")}function F(x){E.postMessage({...x,___type:"warn"})}var H={int:{parse:(x)=>{try{return parseInt(x)}catch(B){return null}},store(x){return`${x}}`}},float:{parse:(x)=>{try{return parseFloat(x)}catch(B){return null}},store(x){return`${x}}`}},string:{parse:(x)=>{return x},store(x){return x}},bigint:{parse:(x)=>{try{return BigInt(x)}catch(B){return null}},store(x){return`${x}}`}},color:{},callback:{parse:(x,B)=>{return()=>new L("$self","refs","data",x)(B,B.refs,B.data)},store(x){return`${x}}`}}};var L=Object.getPrototypeOf(async function(){}).constructor,E=new BroadcastChannel("advect:log");E.onmessage=(x)=>w(x);var T=["body","iframe","img","link","object","script","style","audio","video"];var $={async prerender(x){return""},async load({urls:x}){const B=[],I=[];if(Array.isArray(x))I.push(...x);if(typeof x=="string")I.push(x);for(let z of I){const G=await fetch(z).then((D)=>D.text()).then(async(D)=>await $.build({template:D}));B.push(...G)}return B},async build({template:x}){const B=Q(x),I=Z.create(String.raw`${B}`),z=[];for(let G of I){const D={tagName:"",module:"",template:"",templateNode:null,refs:[],root:"light",shadow:"closed",watched_attrs:{},mutation:{attributeFilter:[],attributes:!0,characterData:!1,childList:!0,subtree:!0},intersection:{margin:0.5,threshhold:1},logs:[]};if(G.tagName.toLowerCase()==="template"){if(!G.attributes.id){F("advect Template must have an id that will become the tag name");continue}const P=G.attributes.id;if(P.indexOf("-")===-1){F("advect Template tag name must contain a hyphen");continue}if(D.tagName=P,D.templateNode=G,G.attributes.root)D.root=G.attributes.root;else D.root="light";if(G.attributes.shadow)D.shadow=G.attributes.shadow;else D.shadow="closed";const Y=[...G.children];while(Y.length>0){const U=Y.shift();if(!U)continue;if(U.tagName==="adv-settings")U.children.forEach((J)=>{if(J.tagName=="adv-mutation"){if(D?.mutation?.attributeFilter&&J.attributes.attributeFilter)D.mutation.attributeFilter=J.attributes.attributeFilter.split(",");if(D?.mutation?.attributes&&J.attributes.attributes)D.mutation.attributes=J.attributes.attributes.toLocaleLowerCase().indexOf("true")!=-1;if(D?.mutation?.characterData&&J.attributes.characterData)D.mutation.characterData=J.attributes.characterData.toLocaleLowerCase().indexOf("true")!=-1;if(D?.mutation?.childList&&J.attributes.childList)D.mutation.childList=J.attributes.childList.toLocaleLowerCase().indexOf("true")!=-1;if(D?.mutation?.subtree&&J.attributes.subtree)D.mutation.subtree=J.attributes.subtree.toLocaleLowerCase().indexOf("true")!=-1}if(J.tagName=="adv-intersection"){if(D?.intersection&&J.attributes.margin)D.intersection.margin=parseFloat(J.attributes.margin);if(D?.intersection.threshhold&&J.attributes.threshhold)D.intersection.threshhold=parseFloat(J.attributes.threshhold);if(D?.intersection.root&&J.attributes.root)D.intersection.root=J.attributes.root}if(J.tagName=="adv-attr"&&J.attributes.name){const R=J.attributes.name,K=J.attributes.type??"string";if(q(K))D.watched_attrs[R]={type:K}}J.remove()}),U.remove();if(U.tagName==="script"){if(U.attributes.type?.toLocaleLowerCase()==="text/adv"&&U.attributes.type){const J=new URL(U.attributes.src);this.load({urls:J.toString()})}if(U.attributes.type?.toLocaleLowerCase()==="module"&&!U.attributes.src)D.module=U.text()}if(U.attributes.ref)D.refs.push(U);Y.push(...U.children)}}const X=G.children.map((P)=>P.html()).join("");D.template=X,z.push(D)}return z}};onconnect=(x)=>{const B=x.ports[0];B.addEventListener("message",(I)=>{try{const{data:z}=I;if(z&&z?.action&&$[z.action])try{$[z.action](z.data).then((G)=>{B.postMessage({action:z.action,result:G,$id:z.$id})})}catch(G){console.log(G),B.postMessage({action:z.action,result:G,$id:z.$id,isError:!0})}else console.warn("Unknown action",z)}catch(z){}}),B.start()};
